# Copyright 2015 TWO SIGMA OPEN SOURCE, LLC
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#           http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

worker_processes  1;
daemon off;
# change this from error to debug for debugging
error_log  "/Users/martinf/.beaker/v1/nginx6134582768995385554/logs/nginx.log" error;
pid nginx.pid;

events {
  worker_connections  1024;
}

http {
  include mime.types;

  # turn this on for debugging
  #access_log /Users/martinf/.beaker/v1/nginx6134582768995385554/logs/access.log;
  access_log off;

  sendfile on;
  tcp_nopush on;

  # i tried setting to 0 and removing the keepalive timer from the ipython client.
  # but it did not fix the problem.
  #keepalive_timeout  0;
  keepalive_timeout  1000;

  proxy_connect_timeout   90;
  proxy_send_timeout      90;
  proxy_read_timeout      1000000;
  proxy_buffers           32 4k;
  client_max_body_size    100M;
  client_body_buffer_size 128k;
  client_body_temp_path   "client_temp";
  proxy_temp_path         "client_temp";
  fastcgi_temp_path       "client_temp";
  uwsgi_temp_path         "client_temp";
  scgi_temp_path          "client_temp";

  server {
    autoindex off;

    # enable requests for specific instances in multi-user environments
    # where a request could be routed to one of many server instances
    # /beaker/<uuid>/foo -> /foo
    rewrite "^/beaker/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/(.*)$" /6dac09a/$1 last;

    listen 127.0.0.1:8801;


    # redirect server error pages to the static page /50x.html and serve them directly from static html directory
    error_page   500 502 503 504  /static/50x.html;
    location /static/ {
      alias "/Applications/Beaker.app/Contents/Resources/dist/src/main/web/static/";
    }

    # login and loginrest are used for the public server option
    location /loginrest/ {
      proxy_pass http://127.0.0.1:8802/rest/login/;
      proxy_set_header Authorization "Basic YmVha2VyOjRnclpQR0pJUDRVejZwb1JxV3YxdlhqS1hpeWFYM1JIUVFFcnlyMkk=";
    }
    location /login/ {
      alias "/Applications/Beaker.app/Contents/Resources/dist/src/main/web/static/";
    }

    # redirect to the starting page
    location = / {
      return 301 $scheme://$http_host/beaker/;
    }
    location = /beaker {
      return 301 $scheme://$http_host/beaker/;
    }

    # version get request
    location = /version {
      add_header Access-Control-Allow-Origin *;
      return 301 "/6dac09a/beaker/rest/util/version";
    }

    location /6dac09a/beaker/rest/util/version {
      proxy_pass http://127.0.0.1:8802/rest/util/version;
      proxy_http_version 1.1;
      proxy_set_header Authorization "Basic YmVha2VyOjRnclpQR0pJUDRVejZwb1JxV3YxdlhqS1hpeWFYM1JIUVFFcnlyMkk=";
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      add_header Access-Control-Allow-Origin *;
    }

    # user directory
    location /user {
      sendfile off;
      expires           0s;
      add_header        Cache-Control private;
      alias "/Users/martinf/.beaker/v1/web";
    }

    # this is the main beaker index page - auto generated via rest call
    location = /beaker/ {
      
      proxy_pass http://127.0.0.1:8802/rest/util/getMainPage;
      proxy_set_header Authorization "Basic YmVha2VyOjRnclpQR0pJUDRVejZwb1JxV3YxdlhqS1hpeWFYM1JIUVFFcnlyMkk=";
      add_header Set-Cookie "XSRF-TOKEN=jr3muoqdnju9cr0575jjeqnlt03glh248n6rl9pcpdet7cvu6ag; path=/";
    }
    location = /6dac09a//beaker/ {
      return 301 $scheme://$http_host/beaker/;
    }

    # this serves the actual (static) content
    location /6dac09a/beaker/ {
      
      rewrite ^/6dac09a/beaker/(.*)$ /$1 break;
      root "/Applications/Beaker.app/Contents/Resources/dist/src/main/web/";
      try_files $uri @dopass;
    }

    # serve the static plugin content
    location /6dac09a/beaker/plugins/ {
      
      rewrite ^/6dac09a/beaker/(.*)$ /$1 break;
      root "/Applications/Beaker.app/Contents/Resources/dist/src/main/web/../../../config/";
      try_files $uri @dopass;
    }

    # forward websockets, auth using path instead of token
    location /6dac09a/beaker/cometd-jr3muoqdnju9cr0575jjeqnlt03glh248n6rl9pcpdet7cvu6ag/ {
      
      rewrite ^/6dac09a/beaker/(.*)$ /$1 break;
      proxy_pass http://127.0.0.1:8802/beaker;
      proxy_http_version 1.1; 
      proxy_set_header Authorization "Basic YmVha2VyOjRnclpQR0pJUDRVejZwb1JxV3YxdlhqS1hpeWFYM1JIUVFFcnlyMkk=";
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }

    # forward all other urls
    location @dopass {
      if ($http_x_xsrf_token != "jr3muoqdnju9cr0575jjeqnlt03glh248n6rl9pcpdet7cvu6ag") {
        return 403;
      }
      
      proxy_pass http://127.0.0.1:8802;
      proxy_http_version 1.1;
      proxy_set_header Authorization "Basic YmVha2VyOjRnclpQR0pJUDRVejZwb1JxV3YxdlhqS1hpeWFYM1JIUVFFcnlyMkk=";
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }

    location ^~ /6dac09a/java.529974010569/ {
  proxy_pass http://127.0.0.1:8812/;
  proxy_set_header Authorization "Basic YmVha2VyOlZUbm5YOFl3M0Q4WVpOd24xNGxzMWFkSUZyZkNSa1pYTVhuNE5mTEY=";
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}


location ^~ /6dac09a/cpp.506391679634/ {
  proxy_pass http://127.0.0.1:8805/;
  proxy_set_header Authorization "Basic YmVha2VyOjF3RXA2S21HUW13bWIxVFJScjZFRHcyT3drZ0dvMzZoZ3E3c1ZST0Y=";
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}


location ^~ /6dac09a/scala.203754123231/ {
  proxy_pass http://127.0.0.1:8816/;
  proxy_set_header Authorization "Basic YmVha2VyOmhydURvYlhmblZlS2JFUW1iOGFNbHlWNVFPbGRDOU42WVlvTEpLeEs=";
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}


location ^~ /6dac09a/node.400828593298/ {
  proxy_pass http://127.0.0.1:8814/;
  proxy_set_header Authorization "Basic YmVha2VyOk80cjZLSk1aM2xPVE9hbXhqQmpHbE85S2JHSzlRQ2k2SkE0RndMSXQ=";
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}


location /6dac09a/iruby.871793898799/api/kernels/kill/ {
  proxy_pass http://127.0.0.1:8808/api/kernels/;
  proxy_set_header Origin "http://127.0.0.1:8808";
}
location /6dac09a/iruby.871793898799/api/kernels/ {
  proxy_pass http://127.0.0.1:8808/api/kernels;
  proxy_set_header Origin "http://127.0.0.1:8808";
}
location /6dac09a/iruby.871793898799/api/kernelspecs/ {
  proxy_pass http://127.0.0.1:8808/api/kernelspecs;
  proxy_set_header Origin "http://127.0.0.1:8808";
}
location /6dac09a/iruby.871793898799/api/sessions/ {
  proxy_pass http://127.0.0.1:8808/api/sessions;
  proxy_set_header Origin "http://127.0.0.1:8808";
}
location ~ /6dac09a/iruby.871793898799/api/kernels/[0-9a-f-]+/channels {
  rewrite ^/6dac09a/iruby.871793898799/(.*)$ /$1 break;
  proxy_pass http://127.0.0.1:8808;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host 127.0.0.1:8808;
  proxy_set_header Origin "http://127.0.0.1:8808";
}
location /6dac09a/iruby.871793898799/login {
  proxy_pass http://127.0.0.1:8808/login;
}
location ~ /6dac09a/iruby.871793898799/api/kernels/[0-9a-f-]+ {
  rewrite ^/6dac09a/iruby.871793898799/(.*)$ /$1 break;
  proxy_pass http://127.0.0.1:8808;
  proxy_set_header Origin "http://127.0.0.1:8808";
}


location ^~ /6dac09a/kdb.789634252945/ {
  proxy_pass http://127.0.0.1:8813/;
  proxy_set_header Authorization "Basic YmVha2VyOm9FMUd2TXhXSDBFTndPZHZNdDhuTDVRNjBsNFhNOGpoUldSeHF6MEo=";
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}


location ^~ /6dac09a/groovy.177612120415/ {
  proxy_pass http://127.0.0.1:8806/;
  proxy_set_header Authorization "Basic YmVha2VyOjVhNXNDODA1MUVyVTNuazc4SHg0N2FwQTVDdVJVeEg4alVYS2Z5NEU=";
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}


location /6dac09a/ipython.195485796987/api/kernels/kill/ {
  proxy_pass http://127.0.0.1:8807/api/kernels/;
  proxy_set_header Origin "http://127.0.0.1:8807";
}
location /6dac09a/ipython.195485796987/api/kernels/ {
  proxy_pass http://127.0.0.1:8807/api/kernels;
  proxy_set_header Origin "http://127.0.0.1:8807";
}
location /6dac09a/ipython.195485796987/api/kernelspecs/ {
  proxy_pass http://127.0.0.1:8807/api/kernelspecs;
  proxy_set_header Origin "http://127.0.0.1:8807";
}
location /6dac09a/ipython.195485796987/api/sessions/ {
  proxy_pass http://127.0.0.1:8807/api/sessions;
  proxy_set_header Origin "http://127.0.0.1:8807";
}
location ~ /6dac09a/ipython.195485796987/api/kernels/[0-9a-f-]+/channels {
  rewrite ^/6dac09a/ipython.195485796987/(.*)$ /$1 break;
  proxy_pass http://127.0.0.1:8807;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host 127.0.0.1:8807;
  proxy_set_header Origin "http://127.0.0.1:8807";
}
location /6dac09a/ipython.195485796987/login {
  proxy_pass http://127.0.0.1:8807/login;
}
location ~ /6dac09a/ipython.195485796987/api/kernels/[0-9a-f-]+ {
  rewrite ^/6dac09a/ipython.195485796987/(.*)$ /$1 break;
  proxy_pass http://127.0.0.1:8807;
  proxy_set_header Origin "http://127.0.0.1:8807";
}


location /6dac09a/torch.103159450677/api/kernels/kill/ {
  proxy_pass http://127.0.0.1:8811/api/kernels/;
  proxy_set_header Origin "http://127.0.0.1:8811";
}
location /6dac09a/torch.103159450677/api/kernels/ {
  proxy_pass http://127.0.0.1:8811/api/kernels;
  proxy_set_header Origin "http://127.0.0.1:8811";
}
location /6dac09a/torch.103159450677/api/kernelspecs/ {
  proxy_pass http://127.0.0.1:8811/api/kernelspecs;
  proxy_set_header Origin "http://127.0.0.1:8811";
}
location /6dac09a/torch.103159450677/api/sessions/ {
  proxy_pass http://127.0.0.1:8811/api/sessions;
  proxy_set_header Origin "http://127.0.0.1:8811";
}
location ~ /6dac09a/torch.103159450677/api/kernels/[0-9a-f-]+/channels {
  rewrite ^/6dac09a/torch.103159450677/(.*)$ /$1 break;
  proxy_pass http://127.0.0.1:8811;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host 127.0.0.1:8811;
  proxy_set_header Origin "http://127.0.0.1:8811";
}
location /6dac09a/torch.103159450677/login {
  proxy_pass http://127.0.0.1:8811/login;
}
location ~ /6dac09a/torch.103159450677/api/kernels/[0-9a-f-]+ {
  rewrite ^/6dac09a/torch.103159450677/(.*)$ /$1 break;
  proxy_pass http://127.0.0.1:8811;
  proxy_set_header Origin "http://127.0.0.1:8811";
}


location ^~ /6dac09a/sql.783392119777/ {
  proxy_pass http://127.0.0.1:8817/;
  proxy_set_header Authorization "Basic YmVha2VyOmljQ0hPOVJDaXBtVm4xY3Q3c3NZVHphVHhGSHJjRHNPRkhIN2t1WTE=";
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}


location /6dac09a/julia.607536835554/api/kernels/kill/ {
  proxy_pass http://127.0.0.1:8809/api/kernels/;
  proxy_set_header Origin "http://127.0.0.1:8809";
}
location /6dac09a/julia.607536835554/api/kernels/ {
  proxy_pass http://127.0.0.1:8809/api/kernels;
  proxy_set_header Origin "http://127.0.0.1:8809";
}
location /6dac09a/julia.607536835554/api/kernelspecs/ {
  proxy_pass http://127.0.0.1:8809/api/kernelspecs;
  proxy_set_header Origin "http://127.0.0.1:8809";
}
location /6dac09a/julia.607536835554/api/sessions/ {
  proxy_pass http://127.0.0.1:8809/api/sessions;
  proxy_set_header Origin "http://127.0.0.1:8809";
}
location ~ /6dac09a/julia.607536835554/api/kernels/[0-9a-f-]+/channels {
  rewrite ^/6dac09a/julia.607536835554/(.*)$ /$1 break;
  proxy_pass http://127.0.0.1:8809;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host 127.0.0.1:8809;
  proxy_set_header Origin "http://127.0.0.1:8809";
}
location /6dac09a/julia.607536835554/login {
  proxy_pass http://127.0.0.1:8809/login;
}
location ~ /6dac09a/julia.607536835554/api/kernels/[0-9a-f-]+ {
  rewrite ^/6dac09a/julia.607536835554/(.*)$ /$1 break;
  proxy_pass http://127.0.0.1:8809;
  proxy_set_header Origin "http://127.0.0.1:8809";
}


location ^~ /6dac09a/r.931070110738/ {
  proxy_pass http://127.0.0.1:8815/;
  proxy_set_header Authorization "Basic YmVha2VyOmZsNW9JcGFyd1dabTBtWmZ5MXZuQnFJaE03bFZFVHE1M2s1WlZFTFM=";
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}


location /6dac09a/python3.611859842829/api/kernels/kill/ {
  proxy_pass http://127.0.0.1:8810/api/kernels/;
  proxy_set_header Origin "http://127.0.0.1:8810";
}
location /6dac09a/python3.611859842829/api/kernels/ {
  proxy_pass http://127.0.0.1:8810/api/kernels;
  proxy_set_header Origin "http://127.0.0.1:8810";
}
location /6dac09a/python3.611859842829/api/kernelspecs/ {
  proxy_pass http://127.0.0.1:8810/api/kernelspecs;
  proxy_set_header Origin "http://127.0.0.1:8810";
}
location /6dac09a/python3.611859842829/api/sessions/ {
  proxy_pass http://127.0.0.1:8810/api/sessions;
  proxy_set_header Origin "http://127.0.0.1:8810";
}
location ~ /6dac09a/python3.611859842829/api/kernels/[0-9a-f-]+/channels {
  rewrite ^/6dac09a/python3.611859842829/(.*)$ /$1 break;
  proxy_pass http://127.0.0.1:8810;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host 127.0.0.1:8810;
  proxy_set_header Origin "http://127.0.0.1:8810";
}
location /6dac09a/python3.611859842829/login {
  proxy_pass http://127.0.0.1:8810/login;
}
location ~ /6dac09a/python3.611859842829/api/kernels/[0-9a-f-]+ {
  rewrite ^/6dac09a/python3.611859842829/(.*)$ /$1 break;
  proxy_pass http://127.0.0.1:8810;
  proxy_set_header Origin "http://127.0.0.1:8810";
}


location ^~ /6dac09a/clojure.661302054713/ {
  proxy_pass http://127.0.0.1:8804/;
  proxy_set_header Authorization "Basic YmVha2VyOjQ3cndXUmsxN2VJWGtqQzFZUGtXeUU4Ymc2VHVrdHM2OFdSSUZiOUw=";
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}



    
    location ~ /6dac09a/[a-z0-9]+\.\d+/cometd/ {
  return 404;
}
  }
  server {
    listen 127.0.0.1:8803;

    location = /restart.943735059904/present.html {
      alias  "/Applications/Beaker.app/Contents/Resources/dist/src/main/web/static/present.html";
    }
  }
}
